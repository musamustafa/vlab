#!/bin/bash

PATH=$PATH:/usr/sbin

# rc.local generated by HelperVM

{% if vxlans is defined %}
echo "Creating VXLAN ptp connections"
{% if vxlans[aliase] is defined %}
{% for key, intvalue in vxlans[aliase].items() %}
# VXLAN {{ intvalue.vni }}
{% if intvalue.bridge is not defined %}
{% set bridge_value = 'br' ~ (key[-1] | int  + 1) %}
{% else %}
{% set bridge_value = intvalue.bridge %}
{% endif %}

{% if intvalue.hostint is not defined %}
{% set host_int = 'eth' ~ (key[-1] | int  + 1) %}
{% else %}
{% set host_int = intvalue.hostint %}
{% endif %}

brctl delif {{ bridge_value }} {{ host_int }}
ip add add {{ intvalue.ip }} dev {{ host_int }}
ip link add vxlan.{{ intvalue.vni }} type vxlan id {{ intvalue.vni }} dev {{ host_int }} dstport 4789 remote {{ intvalue.peerip }}
ip link set vxlan.{{ intvalue.vni }} up
brctl addif {{ bridge_value }} vxlan.{{ intvalue.vni }}
echo 65535 > /sys/class/net/{{ bridge_value }}/bridge/group_fwd_mask

{% endfor %}
{% endif %}
{% endif %}

touch /var/lock/subsys/local

/root/start-script/start-vm.sh
